<p>The <code class="highlighter-rouge">ifelse</code> function is the way to do vectorised <em>if then else</em> in R. One of the first cool things I learned to do in R a few years back, I got from Norman Matloffâ€™s <em>The Art of R Programming</em>. When you have more than one <em>if then</em> statements, you just nest multiple <code class="highlighter-rouge">ifelse</code> functions before you reach the <em>else</em>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">set.seed</span><span class="p">(</span><span class="m">0310</span><span class="p">)</span><span class="w">
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w">

</span><span class="n">the_old_way</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="s1">'A'</span><span class="p">,</span><span class="w">
       </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="s1">'B'</span><span class="p">,</span><span class="w">
              </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="s1">'C'</span><span class="p">,</span><span class="w">
                     </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="s1">'D'</span><span class="p">,</span><span class="w">
                            </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="s1">'E'</span><span class="p">,</span><span class="w">
                                   </span><span class="n">ifelse</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="s1">'F'</span><span class="p">,</span><span class="w">
                                          </span><span class="n">ifelse</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="s1">'G'</span><span class="p">,</span><span class="w">
                                                 </span><span class="s1">'H'</span><span class="p">)))))))</span><span class="w">
</span></code></pre>
</div>

<p>Although this is very functional and fast, it is not exactly pretty. Matters worsen as the variable names get longer and as the logical expressions get more complicated. During the last session of <em>Friday-afternoon-playground</em> at work, I decided to have a go at cleaning this up a bit and having a look at the <code class="highlighter-rouge">lazyeval</code> package along the way. To fully get my mind around the lazy evaluation philosophy, I will need to revisit the vignette a few times. But the wrapper turned out as I intended.</p>

<p>The idea is simple. Get your <em>if then</em> statements in the function <code class="highlighter-rouge">i</code>, get your <em>else</em> value in the function <code class="highlighter-rouge">e</code>, and stitch those together in <code class="highlighter-rouge">ie</code>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">if_stat</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">if_stat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lazyeval</span><span class="o">::</span><span class="n">expr_text</span><span class="p">(</span><span class="n">if_stat</span><span class="p">)</span><span class="w">
  </span><span class="n">then</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lazyeval</span><span class="o">::</span><span class="n">expr_text</span><span class="p">(</span><span class="n">then</span><span class="p">)</span><span class="w">
  </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"ifelse(%s, %s, "</span><span class="p">,</span><span class="w"> </span><span class="n">if_stat</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "ifelse(x &lt; 5 &amp; y &lt; 5, z, "
</code></pre>
</div>

<p>So <code class="highlighter-rouge">i</code> takes the logical expression and the value to return when <code class="highlighter-rouge">TRUE</code>. It spits out a string that is the incomplete part of an <code class="highlighter-rouge">ifelse</code> function. Next we define the <code class="highlighter-rouge">e</code> function that returns the final value if all logical statements in the if-statements are evaluated as <code class="highlighter-rouge">FALSE</code>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">else_ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">else_ret</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lazyeval</span><span class="o">::</span><span class="n">expr_text</span><span class="p">(</span><span class="n">else_ret</span><span class="p">)</span><span class="w">
  </span><span class="n">else_ret</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>And finally we stitch them together. You enter as many <code class="highlighter-rouge">i</code> functions as you like, but only one <code class="highlighter-rouge">e</code> function of course.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">ie</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">...</span><span class="p">)</span><span class="w">
  
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">args</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"ifelse"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">stop</span><span class="p">(</span><span class="s2">"All but the last argument, need to be i functions."</span><span class="p">,</span><span class="w"> </span><span class="n">call.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">args</span><span class="p">[[</span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)]],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"ifelse"</span><span class="p">){</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"Last argument needs to be an e function."</span><span class="p">,</span><span class="w"> </span><span class="n">call.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">args</span><span class="o">$</span><span class="n">final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s1">')'</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w">
  </span><span class="n">eval_string</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">do.call</span><span class="p">(</span><span class="s1">'paste'</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w">
  </span><span class="n">eval</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval_string</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>And there we are. Using the power of the nested <code class="highlighter-rouge">ifelse</code>, but without the messy code. A whole lot easier to write, read, and debug.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">the_new_way</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">ie</span><span class="p">(</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">   </span><span class="s1">'A'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w">  </span><span class="s1">'B'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">           </span><span class="s1">'C'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">  </span><span class="s1">'D'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="s1">'E'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">           </span><span class="s1">'F'</span><span class="p">),</span><span class="w">
    </span><span class="n">i</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w">          </span><span class="s1">'G'</span><span class="p">),</span><span class="w">
    </span><span class="n">e</span><span class="p">(</span><span class="s1">'H'</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="n">all.equal</span><span class="p">(</span><span class="n">the_old_way</span><span class="p">,</span><span class="w"> </span><span class="n">the_new_way</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] TRUE
</code></pre>
</div>

<p>These functions can be found in the <a href="https://github.com/edwinth/thatssorandom">R package on my github</a>, that accompanies this blog. You can easily install it by running <code class="highlighter-rouge">devtools::install_github("edwinth/thatssorandom")</code>. Enjoy!</p>
