<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<head></head>
<title>A recipe for recipes &#8211; That's so Random</title>
<meta name="description" content="If you build statistical or machine learning models, the recipes package can be useful for data preparation. A recipe object is a container that holds all the steps that should be performed to go from the raw data set to the set that is fed into model a algorithm. Once your recipe is ready it can be executed on a data set at once, to perform all the steps. Not only on the train set on which the recipe was created, but also on new data, such as test sets and data that should be scored by the model. This assures that new data gets the exact same preparation as the train set, and thus can be validly scored by the learned model. The author of recipes, Max Kuhn, has provided abundant material to familiarize yourself with the richness of the package, see here, here, and here. I will not dwell on how to use the package. Rather, I’d like to share what in my opinion is a good way to create new steps and checks to the package1. Use of the package is probably intuitive. Developing new steps and checks, however, does require a little more understanding of the package inner workings. With this procedure, or recipe if you like, I hope you will find adding (and maybe even contributing) your own steps and checks becomes easier and more organized.


  
    
      Together with Max I added the checks framework to the package. Where steps are transformations of variables, checks are assertions of them. If a check passes nothing happens. If it fails, it will break the bake method of the recipe and throws an informative error. &#8617;
    
  

">
<meta name="keywords" content="R, recipes, tidyverse, custom steps">


<!-- Twitter Cards -->
<meta name="twitter:title" content="A recipe for recipes">
<meta name="twitter:description" content="If you build statistical or machine learning models, the recipes package can be useful for data preparation. A recipe object is a container that holds all the steps that should be performed to go from the raw data set to the set that is fed into model a algorithm. Once your recipe is ready it can be executed on a data set at once, to perform all the steps. Not only on the train set on which the recipe was created, but also on new data, such as test sets and data that should be scored by the model. This assures that new data gets the exact same preparation as the train set, and thus can be validly scored by the learned model. The author of recipes, Max Kuhn, has provided abundant material to familiarize yourself with the richness of the package, see here, here, and here. I will not dwell on how to use the package. Rather, I’d like to share what in my opinion is a good way to create new steps and checks to the package1. Use of the package is probably intuitive. Developing new steps and checks, however, does require a little more understanding of the package inner workings. With this procedure, or recipe if you like, I hope you will find adding (and maybe even contributing) your own steps and checks becomes easier and more organized.


  
    
      Together with Max I added the checks framework to the package. Where steps are transformations of variables, checks are assertions of them. If a check passes nothing happens. If it fails, it will break the bake method of the recipe and throws an informative error. &#8617;
    
  

">
<meta name="twitter:site" content="@edwin_thoen">
<meta name="twitter:creator" content="@edwin_thoen">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://EdwinTh.github.io/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="A recipe for recipes">
<meta property="og:description" content="If you build statistical or machine learning models, the recipes package can be useful for data preparation. A recipe object is a container that holds all the steps that should be performed to go from the raw data set to the set that is fed into model a algorithm. Once your recipe is ready it can be executed on a data set at once, to perform all the steps. Not only on the train set on which the recipe was created, but also on new data, such as test sets and data that should be scored by the model. This assures that new data gets the exact same preparation as the train set, and thus can be validly scored by the learned model. The author of recipes, Max Kuhn, has provided abundant material to familiarize yourself with the richness of the package, see here, here, and here. I will not dwell on how to use the package. Rather, I’d like to share what in my opinion is a good way to create new steps and checks to the package1. Use of the package is probably intuitive. Developing new steps and checks, however, does require a little more understanding of the package inner workings. With this procedure, or recipe if you like, I hope you will find adding (and maybe even contributing) your own steps and checks becomes easier and more organized.


  
    
      Together with Max I added the checks framework to the package. Where steps are transformations of variables, checks are assertions of them. If a check passes nothing happens. If it fails, it will break the bake method of the recipe and throws an informative error. &#8617;
    
  

">
<meta property="og:url" content="https://EdwinTh.github.io/blog/recipes_blog/">
<meta property="og:site_name" content="That's so Random">





<link rel="canonical" href="https://EdwinTh.github.io/blog/recipes_blog/">
<link href="https://EdwinTh.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="That's so Random Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://EdwinTh.github.io/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://EdwinTh.github.io/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://EdwinTh.github.io/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="https://EdwinTh.github.io/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://EdwinTh.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://EdwinTh.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://EdwinTh.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://EdwinTh.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://EdwinTh.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://EdwinTh.github.io/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="https://EdwinTh.github.io/about/" >About</a></li>
		  
		    
		    <li><a href="https://EdwinTh.github.io/blog/" >Blog</a></li>
		  
		    
		    <li><a href="https://EdwinTh.github.io/blogs-I-read/" >Blogs I read</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="https://EdwinTh.github.io/" class="site-logo" rel="home" title="That's so Random"><img src="https://EdwinTh.github.io/images/site-logo.png" width="200" height="200" alt="That's so Random logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="https://EdwinTh.github.io/">That's so Random</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">A playground for data analysis and R programming.</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="https://EdwinTh.github.io/tags/#R" title="Pages tagged R">R</a></li><li><a href="https://EdwinTh.github.io/tags/#recipes" title="Pages tagged recipes">recipes</a></li><li><a href="https://EdwinTh.github.io/tags/#tidyverse" title="Pages tagged tidyverse">tidyverse</a></li><li><a href="https://EdwinTh.github.io/tags/#custom steps" title="Pages tagged custom steps">custom steps</a></li>
        </ul>
        
          <h1 class="entry-title">A recipe for recipes</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="https://EdwinTh.github.io/images/bio-photo.jpg" class="bio-photo" alt="Edwin Thoen bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Edwin Thoen</span></span>
        <span class="entry-date date published"><time datetime="2018-05-29T14:15:00+02:00"><i class="fa fa-calendar-o"></i> May 29, 2018</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        
      </footer>
      <div class="entry-content">
        <p>If you build statistical or machine learning models, the <code class="highlighter-rouge">recipes</code> package can be useful for data preparation. A <code class="highlighter-rouge">recipe</code> object is a container that holds all the steps that should be performed to go from the raw data set to the set that is fed into model a algorithm. Once your recipe is ready it can be executed on a data set at once, to perform all the steps. Not only on the train set on which the recipe was created, but also on new data, such as test sets and data that should be scored by the model. This assures that new data gets the exact same preparation as the train set, and thus can be validly scored by the learned model. The author of <code class="highlighter-rouge">recipes</code>, Max Kuhn, has provided abundant material to familiarize yourself with the richness of the package, see <a href="https://cran.r-project.org/web/packages/recipes/vignettes/Simple_Example.html">here</a>, <a href="https://www.rstudio.com/resources/webinars/creating-and-preprocessing-a-design-matrix-with-recipes/">here</a>, and <a href="https://cran.r-project.org/web/packages/recipes/index.html">here</a>. I will not dwell on how to use the package. Rather, I’d like to share what in my opinion is a good way to create new <code class="highlighter-rouge">steps</code> and <code class="highlighter-rouge">checks</code> to the package<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. Use of the package is probably intuitive. Developing new <code class="highlighter-rouge">steps</code> and <code class="highlighter-rouge">checks</code>, however, does require a little more understanding of the package inner workings. With this procedure, or recipe if you like, I hope you will find adding (and maybe even contributing) your own <code class="highlighter-rouge">steps</code> and <code class="highlighter-rouge">checks</code> becomes easier and more organized.</p>

<h2 id="s3-classes-in-recipes">S3 classes in <code class="highlighter-rouge">recipes</code></h2>

<p>Lets build a very simple recipe:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">recipes</span><span class="p">)</span><span class="w">
</span><span class="n">rec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recipe</span><span class="p">(</span><span class="n">mtcars</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">step_center</span><span class="p">(</span><span class="n">everything</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">step_scale</span><span class="p">(</span><span class="n">everything</span><span class="p">())</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">check_missing</span><span class="p">(</span><span class="n">everything</span><span class="p">())</span><span class="w">
</span><span class="n">rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">class</span><span class="p">()</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "recipe"
</code></pre>
</div>

<p>As mentioned a recipe is a container for the steps and checks. It is a list of class <code class="highlighter-rouge">recipe</code> on which the <code class="highlighter-rouge">prep</code>, <code class="highlighter-rouge">bake</code>, <code class="highlighter-rouge">print</code> and <code class="highlighter-rouge">tidy</code> methods do the work as described in their respective documentation files. The <code class="highlighter-rouge">steps</code> and <code class="highlighter-rouge">checks</code> added to the recipe are stored inside this list. As you can see below, each of them are of their own subclass, as well as of the generic <code class="highlighter-rouge">step</code> or <code class="highlighter-rouge">check</code> classes.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">rec</span><span class="o">$</span><span class="n">steps</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">class</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## [1] "step_center" "step"       
## 
## [[2]]
## [1] "step_scale" "step"      
## 
## [[3]]
## [1] "check_missing" "check"
</code></pre>
</div>

<p>Each subclass has the same four methods defined as the <code class="highlighter-rouge">recipe</code> class. As one of the methods is called on the recipe, it will call the same method on all the steps and checks that are added to the recipe. (Exception is <code class="highlighter-rouge">prep.recipe</code>, which does not only call<code class="highlighter-rouge">prep</code> on all the steps and checks, but also <code class="highlighter-rouge">bake</code>). This means that when implementing a new <code class="highlighter-rouge">step</code> or <code class="highlighter-rouge">check</code>, you should provide these four methods. Additionally, we’ll need the function that is called by the user to add it to the recipe object and a constructor (if you are not sure what this is, see <a href="https://adv-r.hadley.nz/s3.html">15.3.1 of Advanced R by Hadley Wickham</a>).</p>

<h2 id="the-recipes-for-recipes">The recipes for recipes</h2>

<p>When writing a new <code class="highlighter-rouge">step</code> or <code class="highlighter-rouge">check</code> you will probably be inclined to copy-paste an existing step and start tweaking it from the top. Thus, first writing the function, then the constructor, and then the methods one by one. I think this is suboptimal and can get messy quickly. My preferred way is to start by not bothering about <code class="highlighter-rouge">recipes</code> at all, but write a general function that does the preparation work on a single vector. Once you are happy with this function you sit and think about which arguments to this function should be provided with upfront. These should be added as arguments to the function that is called by the user. Next you think about which function arguments are statistics that should be learned on the train set in the <code class="highlighter-rouge">prep</code> part of the <code class="highlighter-rouge">recipe</code>. You’ll then go on and do the constructor that is called by both the main function and the <code class="highlighter-rouge">prep</code> method. Only then you’ll write the function that is called by the user. You’ll custom <code class="highlighter-rouge">step</code> or <code class="highlighter-rouge">check</code> is completed by writing the four methods, since the functionality is already created, these are mostly bookkeeping.</p>

<p>For both checks and steps I made a skeleton available, in which all the “overhead” that should be in a new step or check is present. This is more convenient than copy-paste and existing example and try to figure out what is step specific and should be erased. You’ll find the skeletons <a href="https://github.com/EdwinTh/recipe_for_recipes">on github</a>. Note that for creating your own steps and checks you should clone the <a href="https://github.com/topepo/recipes">package source code</a>, since the helper functions that are used are not exported by the package.</p>

<h2 id="putting-it-to-practice">Putting it to practice</h2>

<p>We are going to do two examples in which the <em>recipe for recipes</em> is applied.</p>

<h3 id="example-1-a-signed-log">Example 1: A signed log</h3>

<p>First up is a signed-log (inspired by <a href="https://www.amazon.com/Practical-Data-Science-Nina-Zumel/dp/1617291560">Practical Data Science with R</a>), which is taking the log over the absolute value of a variable, multiplied by its original sign. Thus, enabling us to take logs over negative values. If a variable is between -1 and 1, we’ll set it to 0, otherwise things get messy.</p>

<h4 id="preparing-the-function">1) preparing the function</h4>

<p>This is what the function on a vector could look like, if we did not bother about <code class="highlighter-rouge">recipes</code>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
         </span><span class="m">0</span><span class="p">,</span><span class="w"> 
         </span><span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="think-about-the-arguments">2) think about the arguments</h4>

<p>The only argument of the function is <code class="highlighter-rouge">base</code>, that should be provided upfront when adding the step to a recipe object. There are no statistics to be learned in the <code class="highlighter-rouge">prep</code> step.</p>

<h4 id="the-constructor">3) the constructor</h4>

<p>Now we are going to write the first of the recipes functions. This is the constructor that produces new instances of the object of class <code class="highlighter-rouge">step_signed_log</code>. The first four arguments are present in each step or check, they are therefore part of the skeletons. The <code class="highlighter-rouge">terms</code> argument will hold the information on which columns the step should be performed. For <code class="highlighter-rouge">role</code>, <code class="highlighter-rouge">train</code> and <code class="highlighter-rouge">skip</code>, please see the documentation in one of the skeletons. <code class="highlighter-rouge">base</code> is <code class="highlighter-rouge">step_signed_log</code> specific, as used in 1). In <code class="highlighter-rouge">prep.step_signed_log</code> the tidyselect arguments will be converted to a character vector holding the actual column names. <code class="highlighter-rouge">columns</code> will store these names in the <code class="highlighter-rouge">step_signed_log</code> object. This container argument will not be necessary if the columns names are also present in another way. For instance, <code class="highlighter-rouge">step_center</code> has the argument <code class="highlighter-rouge">means</code>, that will be populated by the means of the variables of the train set by its <code class="highlighter-rouge">prep</code> method. In the <code class="highlighter-rouge">bake</code> method the names of the columns to be prepared are already provided by the names of the means and there is need to use the <code class="highlighter-rouge">columns</code> argument.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">step_signed_log_new</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">terms</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
           </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">base</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">step</span><span class="p">(</span><span class="w">
      </span><span class="n">subclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"signed_log"</span><span class="p">,</span><span class="w">
      </span><span class="n">terms</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">terms</span><span class="p">,</span><span class="w">
      </span><span class="n">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w">
      </span><span class="n">skip</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">skip</span><span class="p">,</span><span class="w">
      </span><span class="n">trained</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">trained</span><span class="p">,</span><span class="w">
      </span><span class="n">base</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w">
      </span><span class="n">columns</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">columns</span><span class="w">
    </span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-function-to-add-it-to-the-recipe">4) the function to add it to the recipe</h4>

<p>Next up is the function that will be called by the user to add the step to its recipe. You’ll see the internal helper function <code class="highlighter-rouge">add_step</code> is called. It will expand the recipe with the <code class="highlighter-rouge">step_signed_log</code> object that is produced by the constructor we just created.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">step_signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span><span class="w">
           </span><span class="n">...</span><span class="p">,</span><span class="w">
           </span><span class="n">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
           </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">base</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="w">
           </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">add_step</span><span class="p">(</span><span class="w">
      </span><span class="n">recipe</span><span class="p">,</span><span class="w">
      </span><span class="n">step_signed_log_new</span><span class="p">(</span><span class="w">
        </span><span class="n">terms</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse_check</span><span class="p">(</span><span class="n">...</span><span class="p">),</span><span class="w">
        </span><span class="n">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w">
        </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">skip</span><span class="p">,</span><span class="w">
        </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trained</span><span class="p">,</span><span class="w">
        </span><span class="n">base</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w">
        </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">columns</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-prep-method">5) the <code class="highlighter-rouge">prep</code> method</h4>

<p>As recognized in 2) we don’t have to do much in the <code class="highlighter-rouge">prep</code> method of this particular step, since the preparation of new sets does not depend on statistics learned on the train set. The only thing we do here is applying the internal function <code class="highlighter-rouge">terms_select</code> function to replace the <code class="highlighter-rouge">tidyselect</code> selections, by the actual names of the columns on which <code class="highlighter-rouge">step_signed_log</code> should be applied. We call the constructor again, indicating that the step is trained and we supplying the column names at the <code class="highlighter-rouge">columns</code> argument.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">prep.step_signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w">
                                 </span><span class="n">training</span><span class="p">,</span><span class="w">
                                 </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">col_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terms_select</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
  </span><span class="n">step_signed_log_new</span><span class="p">(</span><span class="w">
    </span><span class="n">terms</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w">
    </span><span class="n">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">role</span><span class="p">,</span><span class="w">
    </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">skip</span><span class="p">,</span><span class="w">
    </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
    </span><span class="n">base</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">base</span><span class="p">,</span><span class="w">
    </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_names</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-bake-method">6) the <code class="highlighter-rouge">bake</code> method</h4>

<p>We are now ready to apply the baking function, designed at 1), inside the recipes framework. We loop through the variables, apply the function and return the updated data frame.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">bake.step_signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w">
                                 </span><span class="n">newdata</span><span class="p">,</span><span class="w">
                                 </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">col_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">object</span><span class="o">$</span><span class="n">columns</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">col_names</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newdata</span><span class="p">[[</span><span class="w"> </span><span class="n">col_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">]]</span><span class="w">
    </span><span class="n">newdata</span><span class="p">[,</span><span class="w"> </span><span class="n">col_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
      </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
             </span><span class="m">0</span><span class="p">,</span><span class="w"> 
             </span><span class="nf">sign</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">col</span><span class="p">),</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object</span><span class="o">$</span><span class="n">base</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-print-method">7) the <code class="highlighter-rouge">print</code> method</h4>

<p>This assures pretty printing of the <code class="highlighter-rouge">recipe</code> object to which <code class="highlighter-rouge">step_signed_log</code> is added. You use the internal <code class="highlighter-rouge">printer</code> function with a message specific for the step.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">print.step_signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">()</span><span class="o">$</span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">30</span><span class="p">),</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="s2">"Taking the signed log for "</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
    </span><span class="n">printer</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">columns</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">trained</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w">
    </span><span class="nf">invisible</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-tidy-method">8) the <code class="highlighter-rouge">tidy</code> method</h4>

<p>Finally, <code class="highlighter-rouge">tidy</code> will add a line for this step to the data frame when the <code class="highlighter-rouge">tidy</code> method is called on a recipe.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">tidy.step_signed_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_trained</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">columns</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sel2char</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">res</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Lets do a quick check to see if it works as expected</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">recipe</span><span class="p">(</span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_signed_log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">prep</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">bake</span><span class="p">(</span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-3</span><span class="o">:</span><span class="m">3</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## # A tibble: 7 x 1
##            x
##        &lt;dbl&gt;
## 1 -1.0986123
## 2 -0.6931472
## 3  0.0000000
## 4  0.0000000
## 5  0.0000000
## 6  0.6931472
## 7  1.0986123
</code></pre>
</div>

<h3 id="example-2-a-range-check">Example 2: A range check</h3>

<p>Model predictions might be invalid when the range of a variable in new data is shifted from the range of the variable in the train set. Lets do a second example in which we check if the range of a numeric variable is approximately equal to the range of the variable in the train set. We do so by checking if the variable’s minimum value in the new data is not smaller than its minimum value in the train set. The variable’s maximum value in the test set should not exceed the maximum in the train set. We allow for some slack (proportion of the variable range in the train set) to account for natural variation.</p>

<h4 id="preparing-the-function-1">1) preparing the function</h4>

<p>As mentioned, <code class="highlighter-rouge">checks</code> are about throwing informative errors if assumptions are not met. This is a function we could apply on new variables, without bothering about <code class="highlighter-rouge">recipes</code>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">range_check_func</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w">
                             </span><span class="n">lower</span><span class="p">,</span><span class="w">
                             </span><span class="n">upper</span><span class="p">,</span><span class="w">
                             </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w">
                             </span><span class="n">colname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"x"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">min_x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">max_x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">slack</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">upper</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lower</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">slack_prop</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slack</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">max_x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">upper</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slack</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"min "</span><span class="p">,</span><span class="w"> </span><span class="n">colname</span><span class="p">,</span><span class="w"> </span><span class="s2">" is "</span><span class="p">,</span><span class="w"> </span><span class="n">min_x</span><span class="p">,</span><span class="w"> </span><span class="s2">", lower bound is "</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slack</span><span class="p">,</span><span class="w">
         </span><span class="s2">"\n"</span><span class="p">,</span><span class="w"> </span><span class="s2">"max x is "</span><span class="p">,</span><span class="w"> </span><span class="n">max_x</span><span class="p">,</span><span class="w"> </span><span class="s2">", upper bound is "</span><span class="p">,</span><span class="w"> </span><span class="n">upper</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slack</span><span class="p">,</span><span class="w"> 
         </span><span class="n">call.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slack</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"min "</span><span class="p">,</span><span class="w"> </span><span class="n">colname</span><span class="p">,</span><span class="w"> </span><span class="s2">" is "</span><span class="p">,</span><span class="w"> </span><span class="n">min_x</span><span class="p">,</span><span class="w"> </span><span class="s2">", lower bound is "</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slack</span><span class="p">,</span><span class="w"> 
         </span><span class="n">call.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">upper</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slack</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"max "</span><span class="p">,</span><span class="w"> </span><span class="n">colname</span><span class="p">,</span><span class="w"> </span><span class="s2">" is "</span><span class="p">,</span><span class="w"> </span><span class="n">max_x</span><span class="p">,</span><span class="w"> </span><span class="s2">", upper bound is "</span><span class="p">,</span><span class="w"> </span><span class="n">upper</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slack</span><span class="p">,</span><span class="w"> 
         </span><span class="n">call.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="think-about-the-arguments-1">2) think about the arguments</h4>

<p>The <code class="highlighter-rouge">slack_prop</code> is a choice that the user of the check should make upfront. This is thus an argument of <code class="highlighter-rouge">check_range</code>. Then there are two statistics to be learned in the <code class="highlighter-rouge">prep</code> method: <code class="highlighter-rouge">lower</code> and <code class="highlighter-rouge">upper</code>. These should be arguments of the function and the constructor as well. However, when calling the function these are always <code class="highlighter-rouge">NULL</code>, they are container arguments that will filled when calling <code class="highlighter-rouge">prep.check_range</code>.</p>

<h4 id="the-constructor-1">3) the constructor</h4>

<p>We start again with the four arguments present in every step or check. Subsequently we add the three arguments that we recognized to be part of the check.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">check_range_new</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">role</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
           </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">lower</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">check</span><span class="p">(</span><span class="n">subclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"range"</span><span class="p">,</span><span class="w">
          </span><span class="n">terms</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">terms</span><span class="p">,</span><span class="w">
          </span><span class="n">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w">
          </span><span class="n">trained</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">trained</span><span class="p">,</span><span class="w">
          </span><span class="n">lower</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">lower</span><span class="p">,</span><span class="w">
          </span><span class="n">upper</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">upper</span><span class="p">,</span><span class="w">
          </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slack_prop</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-function-to-add-it-to-the-recipe-1">4) the function to add it to the recipe</h4>

<p>As we know by now, it is just calling the constructor and adding it to the recipe.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">check_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span><span class="w">
           </span><span class="n">...</span><span class="p">,</span><span class="w">
           </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
           </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">lower</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">add_check</span><span class="p">(</span><span class="w">
      </span><span class="n">recipe</span><span class="p">,</span><span class="w">
      </span><span class="n">check_range_new</span><span class="p">(</span><span class="w">
        </span><span class="n">terms</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse_check</span><span class="p">(</span><span class="n">...</span><span class="p">),</span><span class="w">
        </span><span class="n">role</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w">
        </span><span class="n">skip</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">skip</span><span class="p">,</span><span class="w">
        </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trained</span><span class="p">,</span><span class="w">
        </span><span class="n">lower</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">lower</span><span class="p">,</span><span class="w">
        </span><span class="n">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">upper</span><span class="p">,</span><span class="w">
        </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slack_prop</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-prep-method-1">5) the <code class="highlighter-rouge">prep</code> method</h4>

<p>Here the method is getting a lot more interesting, because we actually have work to do. We are calling <code class="highlighter-rouge">vapply</code> on each of the columns the check should be applied on, to derive the minimum and maximum. Again the constructor is called and the learned statistics are now populating the <code class="highlighter-rouge">lower</code> and <code class="highlighter-rouge">upper</code> arguments.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">prep.check_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w">
           </span><span class="n">training</span><span class="p">,</span><span class="w">
           </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w">
           </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">col_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terms_select</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
    </span><span class="n">lower_vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vapply</span><span class="p">(</span><span class="n">training</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="n">col_names</span><span class="p">],</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
    </span><span class="n">upper_vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vapply</span><span class="p">(</span><span class="n">training</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="n">col_names</span><span class="p">],</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
    </span><span class="n">check_range_new</span><span class="p">(</span><span class="w">
      </span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w">
      </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">role</span><span class="p">,</span><span class="w">
      </span><span class="n">trained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
      </span><span class="n">lower</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">lower_vals</span><span class="p">,</span><span class="w">
      </span><span class="n">upper</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">upper_vals</span><span class="p">,</span><span class="w">
      </span><span class="n">slack_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">slack_prop</span><span class="w">
    </span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-bake-method-1">6) the <code class="highlighter-rouge">bake</code> method</h4>

<p>The hard work has been done already. We just get the columns on which to apply the check and check them with the function we created at 1).</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">bake.check_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w">
                             </span><span class="n">newdata</span><span class="p">,</span><span class="w">
                             </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">col_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">object</span><span class="o">$</span><span class="n">lower</span><span class="p">)</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">col_names</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">colname</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">col_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
    </span><span class="n">range_check_func</span><span class="p">(</span><span class="n">newdata</span><span class="p">[[</span><span class="w"> </span><span class="n">colname</span><span class="w"> </span><span class="p">]],</span><span class="w">
                     </span><span class="n">object</span><span class="o">$</span><span class="n">lower</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span><span class="w">
                     </span><span class="n">object</span><span class="o">$</span><span class="n">upper</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span><span class="w">
                     </span><span class="n">object</span><span class="o">$</span><span class="n">slack_prop</span><span class="p">,</span><span class="w">
                     </span><span class="n">colname</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-print-method-1">7) the <code class="highlighter-rouge">print</code> method</h4>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">print.check_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">()</span><span class="o">$</span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">30</span><span class="p">),</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="s2">"Checking range of "</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
    </span><span class="n">printer</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">lower</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">trained</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w">
    </span><span class="nf">invisible</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="the-tidy-method-1">8) the <code class="highlighter-rouge">tidy</code> method</h4>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">tidy.check_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_trained</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">columns</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sel2char</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">terms</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">res</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Again, we check quickly if it works</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">cr1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="o">:</span><span class="m">100</span><span class="p">)</span><span class="w">
</span><span class="n">cr2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="o">:</span><span class="m">101</span><span class="p">)</span><span class="w">
</span><span class="n">cr3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-6</span><span class="o">:</span><span class="m">100</span><span class="p">)</span><span class="w">
</span><span class="n">cr4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="o">:</span><span class="m">106</span><span class="p">)</span><span class="w">
</span><span class="n">recipe_cr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recipe</span><span class="p">(</span><span class="n">cr1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">check_range</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">prep</span><span class="p">()</span><span class="w">
</span><span class="n">cr2_baked</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recipe_cr</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">bake</span><span class="p">(</span><span class="n">cr2</span><span class="p">)</span><span class="w">
</span><span class="n">cr3_baked</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recipe_cr</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">bake</span><span class="p">(</span><span class="n">cr3</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Error: min x is -6, lower bound is -5
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">cr4_baked</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recipe_cr</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">bake</span><span class="p">(</span><span class="n">cr4</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Error: max x is 106, upper bound is 105
</code></pre>
</div>

<h2 id="conclusion">Conclusion</h2>

<p>If you like to add your own data preparation steps and data checks to the <code class="highlighter-rouge">recipes</code> package, I advise you to do this in a structured way so you are not distracting by the bookkeeping while implementing the functionality. I propose eight subsequent parts to develop a new step or check:</p>

<p>1) Create a function on a vector that could be applied in the <code class="highlighter-rouge">bake</code> method, but does not bother about <code class="highlighter-rouge">recipes</code> yet.
2) Recognize which function arguments should be provided upfront and which should be learned in the <code class="highlighter-rouge">prep</code> method.
3) Create a constructor in the form <code class="highlighter-rouge">step_&lt;name&gt;_new</code> or <code class="highlighter-rouge">check_&lt;name&gt;_new</code>.
4) Create the actual function to add the step or check to a recipe, in the form <code class="highlighter-rouge">step_&lt;name&gt;</code> or <code class="highlighter-rouge">check_&lt;name&gt;</code>.
5) Write the <code class="highlighter-rouge">prep</code> method.
6) Write the <code class="highlighter-rouge">bake</code> method.
7) Write the <code class="highlighter-rouge">print</code> method.
8) Write the <code class="highlighter-rouge">tidy</code> method.</p>

<p>As mentioned, the source code is maintained <a href="https://github.com/topepo/recipes">here</a>. Make sure to clone the latest version to access the package internal functions.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Together with Max I added the <code class="highlighter-rouge">checks</code> framework to the package. Where <code class="highlighter-rouge">steps</code> are transformations of variables, <code class="highlighter-rouge">checks</code> are assertions of them. If a check passes nothing happens. If it fails, it will break the <code class="highlighter-rouge">bake</code> method of the recipe and throws an informative error. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thats-so-random'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="https://EdwinTh.github.io/olympics-dataprep/" class="btn" title="Building the Olympics blog: tidy data preparation">Previous</a>
      
      
        <a href="https://EdwinTh.github.io/blog/s3-generics/" class="btn" title="Why your S3 method isn't working">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2020 Edwin Thoen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/edwin_thoen" title="Edwin Thoen on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	<a href="https://linkedin.com/in/edwin-thoen-3139a131?trk=hp-identity-name" title="Edwin Thoen on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/2119315/edwin" title="Edwin Thoen on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	
	
	<a href="https://github.com/EdwinTh" title="Edwin Thoen on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="https://EdwinTh.github.io/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'https://EdwinTh.github.io';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://EdwinTh.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://EdwinTh.github.io/assets/js/scripts.min.js"></script>




</body>
</html>
